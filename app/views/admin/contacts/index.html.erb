<% content_for :title, 'Contacts' %>
<% content_for :subtitle, 'Manage customer inquiries and support requests' %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Enhanced Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-inbox text-blue-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @total_contacts %></h3>
          <p class="text-gray-600">Total Contacts</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-exclamation-circle text-yellow-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @new_contacts_count %></h3>
          <p class="text-gray-600">New Messages</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-clock text-orange-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @pending_contacts_count %></h3>
          <p class="text-gray-600">Pending</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-check-circle text-green-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @responded_contacts_count %></h3>
          <p class="text-gray-600">Responded</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-times-circle text-gray-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @closed_contacts_count %></h3>
          <p class="text-gray-600">Closed</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Search & Filters</h3>
    </div>
    <div class="p-6">
      <%= form_with url: admin_contacts_path, method: :get, local: true, class: "space-y-4" do |form| %>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <%= form.label :search, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.text_field :search, value: params[:search], placeholder: "Name, email, phone, message...", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          
          <div>
            <%= form.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.select :status, options_for_select([['All Statuses', '']] + Contact.contact_statuses.keys.map { |s| [s.titleize, s] }, params[:status]), {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          
          <div>
            <%= form.label :requirement, "Requirement", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.select :requirement, options_for_select([['All Requirements', '']] + @available_requirements.map { |r| [r.titleize, r] }, params[:requirement]), {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          
          <div>
            <%= form.label :date_from, "Date From", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.date_field :date_from, value: params[:date_from], class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <%= form.label :date_to, "Date To", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.date_field :date_to, value: params[:date_to], class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          
          <div class="flex items-end space-x-2">
            <%= form.submit "Search", class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium" %>
            <%= link_to "Clear", admin_contacts_path, class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium" %>
          </div>
        </div>
          <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all');
  const contactCheckboxes = document.querySelectorAll('.contact-checkbox');
  const bulkActionsDiv = document.getElementById('bulk-actions');
  const bulkUpdateBtn = document.getElementById('bulk-update-btn');
  const bulkUpdateForm = document.getElementById('bulk-update-form');

  // Handle select all checkbox
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      contactCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateBulkActionsVisibility();
    });
  }

  // Handle individual checkboxes
  contactCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      updateBulkActionsVisibility();
      updateSelectAllCheckbox();
    });
  });

  // Update bulk actions visibility
  function updateBulkActionsVisibility() {
    const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
    if (checkedBoxes.length > 0) {
      bulkActionsDiv.style.display = 'block';
      bulkUpdateBtn.disabled = false;
    } else {
      bulkActionsDiv.style.display = 'none';
      bulkUpdateBtn.disabled = true;
    }
  }

  // Update select all checkbox state
  function updateSelectAllCheckbox() {
    const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
    const totalBoxes = contactCheckboxes.length;
    
    if (checkedBoxes.length === 0) {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = false;
    } else if (checkedBoxes.length === totalBoxes) {
      selectAllCheckbox.checked = true;
      selectAllCheckbox.indeterminate = false;
    } else {
      selectAllCheckbox.checked = false;
      selectAllCheckbox.indeterminate = true;
    }
  }

  // Handle bulk update form submission
  if (bulkUpdateForm) {
    bulkUpdateForm.addEventListener('submit', function(e) {
      const checkedBoxes = document.querySelectorAll('.contact-checkbox:checked');
      const newStatus = document.querySelector('select[name="new_status"]').value;
      
      if (checkedBoxes.length === 0) {
        e.preventDefault();
        alert('Please select at least one contact to update.');
        return;
      }
      
      if (!newStatus) {
        e.preventDefault();
        alert('Please select a new status.');
        return;
      }
      
      if (!confirm(`Are you sure you want to update ${checkedBoxes.length} contact(s) to "${newStatus}" status?`)) {
        e.preventDefault();
        return;
      }
    });
  }
});
</script>

  <!-- Bulk Actions -->
  <div class="bg-white rounded-lg shadow mb-6" id="bulk-actions" style="display: none;">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Bulk Actions</h3>
    </div>
    <div class="p-6">
      <%= form_with url: bulk_update_admin_contacts_path, method: :post, local: true, id: "bulk-update-form" do |form| %>
        <div class="flex items-center space-x-4">
          <div class="flex-1">
            <%= form.label :new_status, "Update Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.select :new_status, Contact.contact_statuses.keys.map { |s| [s.titleize, s] }, { prompt: "Select new status..." }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          <div class="flex items-end">
            <%= form.submit "Update Selected", class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium", disabled: true, id: "bulk-update-btn" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Contacts Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">
          Contact Submissions 
          <% if params[:search].present? || params[:status].present? || params[:requirement].present? || params[:date_from].present? || params[:date_to].present? %>
            <span class="text-sm font-normal text-gray-500">
              (Showing <%= @contacts.count %> of <%= @filtered_count %> results)
            </span>
          <% else %>
            <span class="text-sm font-normal text-gray-500">(<%= @total_contacts %> total)</span>
          <% end %>
        </h3>
        <div class="flex items-center space-x-2">
          <% if params[:search].present? || params[:status].present? || params[:requirement].present? || params[:date_from].present? || params[:date_to].present? %>
            <span class="text-sm text-gray-500">
              Filtered results
            </span>
          <% end %>
        </div>
      </div>
    </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <input type="checkbox" id="select-all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requirement</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @contacts.each do |contact| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <input type="checkbox" name="contact_ids[]" value="<%= contact.id %>" class="contact-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= contact.name %></div>
                    <div class="text-sm text-gray-500">
                      <a href="mailto:<%= contact.email %>" class="hover:text-blue-600"><%= contact.email %></a>
                    </div>
                    <div class="text-sm text-gray-500">
                      <a href="tel:<%= contact.phone %>" class="hover:text-blue-600"><%= contact.phone %></a>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">
                    <%= contact.requirement&.titleize || 'General Inquiry' %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= contact.role&.titleize || 'Not specified' %>
                  </div>
                  <% if contact.source.present? %>
                    <div class="text-xs text-gray-400">
                      via <%= contact.source.titleize %>
                    </div>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    <%= case contact.contact_status
                        when 'unread'
                          'bg-yellow-100 text-yellow-800'
                        when 'in_progress'
                          'bg-blue-100 text-blue-800'
                        when 'responded'
                          'bg-green-100 text-green-800'
                        when 'closed'
                          'bg-gray-100 text-gray-800'
                        end %>">
                    <%= contact.contact_status.titleize %>
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <%= contact.created_at.strftime("%b %d, %Y") %>
                  <br>
                  <span class="text-xs"><%= contact.created_at.strftime("%I:%M %p") %></span>
                  <% if contact.updated_at != contact.created_at %>
                    <br>
                    <span class="text-xs text-gray-400">Updated: <%= contact.updated_at.strftime("%b %d") %></span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <div class="flex items-center space-x-2">
                    <%= link_to admin_contact_path(contact), class: "text-blue-600 hover:text-blue-900" do %>
                      <i class="fas fa-eye mr-1"></i>View
                    <% end %>
                    <%= link_to "mailto:#{contact.email}?subject=Re: Your inquiry to PiSoftSolutions", class: "text-green-600 hover:text-green-900" do %>
                      <i class="fas fa-reply mr-1"></i>Reply
                    <% end %>
                    <%= button_to admin_contact_path(contact), method: :delete, data: { confirm: 'Are you sure you want to delete this contact?' }, class: "text-red-600 hover:text-red-900 bg-transparent border-none cursor-pointer", form: { style: "display: inline;" } do %>
                      <i class="fas fa-trash mr-1"></i>Delete
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <% if @contacts.empty? %>
        <div class="text-center py-12">
          <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-inbox text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">
            <% if params[:search].present? || params[:status].present? || params[:requirement].present? || params[:date_from].present? || params[:date_to].present? %>
              No contacts found matching your criteria
            <% else %>
              No contact submissions yet
            <% end %>
          </h3>
          <p class="text-gray-500">
            <% if params[:search].present? || params[:status].present? || params[:requirement].present? || params[:date_from].present? || params[:date_to].present? %>
              Try adjusting your search criteria or <%= link_to "view all contacts", admin_contacts_path, class: "text-blue-600 hover:text-blue-800" %>.
            <% else %>
              When customers submit contact forms, they will appear here.
            <% end %>
          </p>
        </div>
      <% end %>
    </div>

    <!-- Results Count -->
    <% if @contacts.any? %>
      <div class="px-6 py-4 border-t border-gray-200">
        <div class="text-sm text-gray-700">
          Showing <%= @contacts.count %> of <%= @filtered_count || @total_contacts %> results
        </div>
      </div>
    <% end %>
  </div>
</div>
