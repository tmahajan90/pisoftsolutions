<% content_for :title, 'Products' %>
<% content_for :subtitle, 'Manage your product catalog' %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-box text-blue-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @total_products %></h3>
          <p class="text-gray-600">Total Products</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @low_stock_products %></h3>
          <p class="text-gray-600">Low Stock Items</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-tags text-green-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @categories.count %></h3>
          <p class="text-gray-600">Categories</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-toggle-on text-purple-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= Product.active.count %></h3>
          <p class="text-gray-600">Active Products</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Search & Filters</h3>
        <div class="flex space-x-2">
          <%= link_to admin_products_path, class: "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium" do %>
            <i class="fas fa-list mr-2"></i>View All
          <% end %>
          <%= link_to new_admin_product_path, class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium" do %>
            <i class="fas fa-plus mr-2"></i>Add Product
          <% end %>
        </div>
      </div>
    </div>
    <div class="p-6">
      <%= form_with url: admin_products_path, method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-3 gap-4" do |form| %>
        <div>
          <%= form.label :search, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :search, value: params[:search], placeholder: "Product name, description, or category...", class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div>
          <%= form.label :category, "Category", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.select :category, options_for_select([['All Categories', '']] + @categories.map { |cat| [cat, cat] }, params[:category]), {}, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
        <div class="flex items-end">
          <%= form.submit "Search", class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium" %>
          <%= link_to "Clear", admin_products_path, class: "ml-2 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md font-medium" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="bg-white rounded-lg shadow mb-6" id="bulk-actions" style="display: none;">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Bulk Actions</h3>
    </div>
    <div class="p-6">
      <%= form_with url: bulk_toggle_status_admin_products_path, method: :post, local: true, id: "bulk-status-form" do |form| %>
        <div class="flex items-center space-x-4">
          <div class="flex-1">
            <%= form.label :new_status, "Update Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.select :new_status, [['Activate Products', 'true'], ['Deactivate Products', 'false']], { prompt: "Select action..." }, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
          </div>
          <div class="flex items-end">
            <%= form.submit "Update Selected", class: "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md font-medium", disabled: true, id: "bulk-status-btn" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Trial Management -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Trial Management</h3>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-center mb-3">
            <i class="fas fa-gift text-blue-600 mr-2"></i>
            <h4 class="font-medium text-blue-900">Bulk Trial Price Update</h4>
          </div>
          <p class="text-sm text-gray-600 mb-3">Update trial price across all products at once</p>
          
          <%= form_with url: update_trial_prices_admin_products_path, method: :post, local: true, class: "space-y-3" do |form| %>
            <div>
              <%= form.label :trial_price, "New Trial Price (₹)", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.number_field :trial_price, step: 0.01, min: 0, value: 1, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
            </div>
            <%= form.submit "Update All Trial Prices", class: "w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium" %>
          <% end %>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center mb-3">
            <i class="fas fa-chart-bar text-green-600 mr-2"></i>
            <h4 class="font-medium text-green-900">Trial Statistics</h4>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Products with Trials:</span>
              <span class="font-medium"><%= Product.joins(:validity_options).where(validity_options: { duration_type: 'days', duration_value: 1 }).count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Total Trial Usage:</span>
              <span class="font-medium"><%= TrialUsage.count %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Current Trial Price:</span>
              <span class="font-medium">₹<%= ValidityOption.where(duration_type: 'days', duration_value: 1).first&.price || 1 %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="bg-white rounded-lg shadow mb-6">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Quick Actions</h3>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="text-center p-4 bg-blue-50 rounded-lg">
          <i class="fas fa-plus-circle text-blue-600 text-2xl mb-2"></i>
          <h4 class="font-medium text-gray-900">Add Product</h4>
          <p class="text-sm text-gray-600">Create new product</p>
          <%= link_to new_admin_product_path, class: "mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium" do %>
            Add Now →
          <% end %>
        </div>
        <div class="text-center p-4 bg-yellow-50 rounded-lg">
          <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
          <h4 class="font-medium text-gray-900">Low Stock</h4>
          <p class="text-sm text-gray-600"><%= @low_stock_products %> items</p>
          <%= link_to admin_products_path(category: ''), class: "mt-2 inline-block text-yellow-600 hover:text-yellow-800 text-sm font-medium" do %>
            View All →
          <% end %>
        </div>
        <div class="text-center p-4 bg-green-50 rounded-lg">
          <i class="fas fa-tags text-green-600 text-2xl mb-2"></i>
          <h4 class="font-medium text-gray-900">Categories</h4>
          <p class="text-sm text-gray-600"><%= @categories.count %> categories</p>
          <span class="mt-2 inline-block text-green-600 text-sm font-medium">
            Manage →
          </span>
        </div>
        <div class="text-center p-4 bg-purple-50 rounded-lg">
          <i class="fas fa-chart-line text-purple-600 text-2xl mb-2"></i>
          <h4 class="font-medium text-gray-900">Analytics</h4>
          <p class="text-sm text-gray-600">View reports</p>
          <%= link_to admin_dashboard_path, class: "mt-2 inline-block text-purple-600 hover:text-purple-800 text-sm font-medium" do %>
            Dashboard →
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Products (<%= @products.count %> of <%= @total_products %>)</h3>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input type="checkbox" id="select-all-products" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            </th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colors</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @products.each do |product| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" name="product_ids[]" value="<%= product.id %>" class="product-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              </td>
              <td class="px-4 py-4">
                <div class="flex items-center">
                  <% if product.image_url.present? %>
                    <% if product.image_url.start_with?('http') %>
                      <img class="h-8 w-8 rounded object-cover" src="<%= product.image_url %>" alt="<%= product.name %>">
                    <% else %>
                      <div class="h-8 w-8 rounded bg-gray-200 flex items-center justify-center">
                        <i class="<%= product.image_url %> text-gray-600 text-xs"></i>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="h-8 w-8 rounded bg-gray-200 flex items-center justify-center">
                      <i class="fas fa-image text-gray-400 text-xs"></i>
                    </div>
                  <% end %>
                  <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900"><%= truncate(product.name, length: 25) %></div>
                    <div class="text-xs text-gray-500"><%= truncate(product.description, length: 30) %></div>
                  </div>
                </div>
              </td>
              <td class="px-3 py-4">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                  <%= truncate(product.category, length: 15) %>
                </span>
              </td>
              <td class="px-3 py-4">
                <div class="flex flex-wrap gap-1">
                  <% if product.color.present? %>
                    <% color_data = Product.available_colors[product.color.to_sym] %>
                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-<%= color_data[:css_class] %>-100 text-<%= color_data[:css_class] %>-800 border border-<%= color_data[:css_class] %>-200">
                      <span class="w-2 h-2 rounded-full mr-1 bg-<%= color_data[:css_class] %>-500"></span>
                      <%= color_data[:name] %>
                    </span>
                  <% else %>
                    <span class="text-xs text-gray-500 italic">No color</span>
                  <% end %>
                </div>
              </td>
              <td class="px-3 py-4">
                <div class="text-sm font-semibold text-gray-900">₹<%= number_with_precision(product.price, precision: 0) %></div>
                <% if product.original_price && product.original_price > product.price %>
                  <div class="text-xs text-gray-500 line-through">₹<%= number_with_precision(product.original_price, precision: 0) %></div>
                <% end %>
              </td>
              <td class="px-3 py-4">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                  <%= product.stock < 10 ? 'bg-red-100 text-red-800' : product.stock < 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800' %>">
                  <%= product.stock %>
                </span>
              </td>
              <td class="px-3 py-4">
                <div class="flex items-center">
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    <%= product.active? ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                    <%= product.active? ? 'Active' : 'Inactive' %>
                  </span>
                  <%= button_to toggle_status_admin_product_path(product), 
                      method: :patch, 
                      class: "ml-1 text-xs px-1 py-1 rounded",
                      form: { style: "display: inline;" } do %>
                    <span class="<%= product.active? ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800' %>">
                      <%= product.active? ? 'Off' : 'On' %>
                    </span>
                  <% end %>
                </div>
              </td>
              <td class="px-3 py-4">
                <div class="flex items-center">
                  <div class="flex items-center">
                    <% 5.times do |i| %>
                      <i class="fas fa-star <%= i < product.rating.to_i ? 'text-yellow-400' : 'text-gray-300' %> text-xs"></i>
                    <% end %>
                  </div>
                  <span class="ml-1 text-xs text-gray-500">(<%= product.rating %>)</span>
                </div>
              </td>
              <td class="px-3 py-4 text-sm font-medium">
                <div class="flex items-center space-x-2">
                  <%= link_to admin_product_path(product), 
                      class: "text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50 transition-colors",
                      title: "View Product" do %>
                    <i class="fas fa-eye text-sm"></i>
                  <% end %>
                  
                  <%= link_to edit_admin_product_path(product), 
                      class: "text-indigo-600 hover:text-indigo-900 p-1 rounded hover:bg-indigo-50 transition-colors",
                      title: "Edit Product" do %>
                    <i class="fas fa-edit text-sm"></i>
                  <% end %>
                  
                  <%= button_to admin_product_path(product), 
                      method: :delete, 
                      data: { confirm: 'Are you sure you want to delete this product?' },
                      class: "text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50 transition-colors",
                      form: { style: "display: inline;" },
                      title: "Delete Product" do %>
                    <i class="fas fa-trash text-sm"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
