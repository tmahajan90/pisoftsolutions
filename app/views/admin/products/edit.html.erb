<% content_for :title, "Edit #{@product.name}" %>
<% content_for :subtitle, 'Update product information' %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Back Button -->
  <div class="mb-6">
    <%= link_to admin_product_path(@product), class: "inline-flex items-center text-blue-600 hover:text-blue-900" do %>
      <i class="fas fa-arrow-left mr-2"></i>Back to Product
    <% end %>
  </div>

  <div class="bg-white rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Edit Product</h3>
    </div>
    
    <div class="p-6">
      <%= form_with model: [:admin, @product], local: true, class: "space-y-6" do |form| %>
        <% if @product.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-md p-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400"></i>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  <%= pluralize(@product.errors.count, "error") %> prohibited this product from being saved:
                </h3>
                <div class="mt-2 text-sm text-red-700">
                  <ul class="list-disc pl-5 space-y-1">
                    <% @product.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Basic Information -->
          <div class="space-y-4">
            <h4 class="text-lg font-medium text-gray-900">Basic Information</h4>
            
            <div>
              <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :name, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Product name" %>
            </div>
            
            <div>
              <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_area :description, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Product description" %>
            </div>
            
            <div>
              <%= form.label :category, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :category, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "e.g., Electronics, Clothing" %>
            </div>
            
            <div>
              <%= form.label :image_url, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.url_field :image_url, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "https://example.com/image.jpg" %>
            </div>
          </div>
          
          <!-- Pricing & Stock -->
          <div class="space-y-4">
            <h4 class="text-lg font-medium text-gray-900">Pricing & Stock</h4>
            
            <div>
              <%= form.label :price, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.number_field :price, step: 0.01, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "0.00" %>
            </div>
            
            <div>
              <%= form.label :original_price, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.number_field :original_price, step: 0.01, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Original price (optional)" %>
            </div>
            
            <div>
              <%= form.label :stock, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.number_field :stock, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "0" %>
            </div>
            
            <div>
              <%= form.label :rating, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.number_field :rating, step: 0.1, min: 0, max: 5, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "0.0" %>
            </div>
            
            <div>
              <%= form.label :active, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <div class="flex items-center">
                <%= form.check_box :active, class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
                <label class="ml-2 text-sm text-gray-700">Active (visible on products page)</label>
              </div>
              <p class="text-xs text-gray-500 mt-1">Uncheck to hide this product from customers</p>
            </div>
          </div>
        </div>
        
        <!-- Additional Details -->
        <div class="border-t pt-6">
          <h4 class="text-lg font-medium text-gray-900 mb-4">Additional Details</h4>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <%= form.label :color, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :color, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "e.g., Red, Blue, Black" %>
            </div>
            
            <div>
              <%= form.label :badge, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :badge, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "e.g., New, Sale, Featured" %>
            </div>
          </div>
        </div>
        
        <!-- Product Features -->
        <div class="border-t pt-6">
          <h4 class="text-lg font-medium text-gray-900 mb-4">Product Features</h4>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div class="flex items-center">
              <i class="fas fa-info-circle text-blue-600 mr-2"></i>
              <span class="text-sm text-blue-800 font-medium">Features Management:</span>
            </div>
            <p class="text-sm text-blue-700 mt-1">Add or remove features for this product. Features will be displayed to customers on the product page.</p>
          </div>
          
          <div class="space-y-4">
            <!-- Available Features -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Available Features</label>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <% available_features = [
                  'Easy Setup & Integration',
                  '24/7 Technical Support',
                  '99.9% Uptime Guarantee',
                  'Regular Updates',
                  'Analytics & Reporting',
                  'Mobile Responsive',
                  'API Access',
                  'Custom Branding',
                  'Multi-language Support',
                  'Advanced Security',
                  'Cloud Storage',
                  'Real-time Sync',
                  'Team Collaboration',
                  'Data Backup',
                  'Performance Monitoring'
                ] %>
                
                <% available_features.each do |feature| %>
                  <div class="flex items-center">
                    <%= check_box_tag "product[features][]", feature, @product.has_feature?(feature), 
                        id: "feature_#{feature.parameterize}", 
                        class: "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" %>
                    <label for="feature_<%= feature.parameterize %>" class="ml-2 text-sm text-gray-700">
                      <%= feature %>
                    </label>
                  </div>
                <% end %>
              </div>
            </div>
            
            <!-- Custom Features -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Custom Features</label>
              
              <!-- Debug info (remove in production) -->
              <% if Rails.env.development? %>
                <div class="bg-yellow-50 border border-yellow-200 rounded p-2 mb-2 text-xs">
                  <strong>Debug Info:</strong><br>
                  All features: <%= @product.features_list.inspect %><br>
                  Available features: <%= available_features.inspect %><br>
                  Custom features: <%= @product.features_list.select { |f| !available_features.include?(f) }.inspect %>
                </div>
              <% end %>
              
              <div class="space-y-2" id="custom-features-container">
                <% custom_features = @product.features_list.select { |f| !available_features.include?(f) } %>
                <% if custom_features.any? %>
                  <% custom_features.each do |feature| %>
                    <div class="flex items-center space-x-2 custom-feature-item">
                      <input type="text" name="product[features][]" value="<%= feature %>" 
                             class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                             placeholder="Enter custom feature">
                      <button type="button" onclick="removeCustomFeature(this)" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  <% end %>
                <% else %>
                  <div class="text-sm text-gray-500 italic">No custom features added yet. Click "Add Custom Feature" to add one.</div>
                <% end %>
              </div>
              <button type="button" onclick="addCustomFeature()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-plus mr-1"></i>Add Custom Feature
              </button>
            </div>
          </div>
        </div>
        
        <!-- Trial Management -->
        <% if @product.has_trial_option? %>
          <div class="border-t pt-6">
            <h4 class="text-lg font-medium text-gray-900 mb-4">Trial Management</h4>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-center mb-3">
                <i class="fas fa-gift text-blue-600 mr-2"></i>
                <span class="font-medium text-blue-900">1-Day Trial Settings</span>
              </div>
              
              <% trial_option = @product.trial_option %>
              <% if trial_option %>
                <%= form.fields_for :validity_options, trial_option do |trial_form| %>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Trial Price (₹)</label>
                      <%= trial_form.number_field :price, step: 0.01, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "1.00" %>
                      <p class="text-xs text-gray-500 mt-1">Set to ₹1 for nominal charge or ₹0 for free trial</p>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Trial Label</label>
                      <%= trial_form.text_field :label, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "1 Day Trial" %>
                    </div>
                  </div>
                  
                  <div class="mt-3 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                      <span class="font-medium">Current Trial Usage:</span> <%= @product.trial_usage_count %> users
                    </div>
                    <div class="flex items-center">
                      <%= trial_form.check_box :is_default, class: "mr-2 trial-default-checkbox" %>
                      <label class="text-sm text-gray-700">Show as default option</label>
                    </div>
                  </div>
                  
                  <%= trial_form.hidden_field :duration_type, value: 'days' %>
                  <%= trial_form.hidden_field :duration_value, value: 1 %>
                  <%= trial_form.hidden_field :sort_order, value: 0 %>
                <% end %>
              <% else %>
                <div class="text-sm text-gray-600">
                  <p>No trial option found. Add a validity option with "Days" duration and value "1" to create a trial.</p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Validity Options -->
        <div class="border-t pt-6">
          <h4 class="text-lg font-medium text-gray-900 mb-4">Validity Options (Optional)</h4>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div class="flex items-center">
              <i class="fas fa-info-circle text-blue-600 mr-2"></i>
              <span class="text-sm text-blue-800 font-medium">Important:</span>
            </div>
            <p class="text-sm text-blue-700 mt-1">Only one validity option can be set as default per product. Selecting a new default will automatically uncheck the previous default option.</p>
          </div>
          
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <p class="text-sm text-gray-600">Manage validity options for this product</p>
              <button type="button" onclick="addValidityOption()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-plus mr-1"></i>Add Option
              </button>
            </div>
            
            <div id="validity-options-container" class="space-y-4">
              <% @product.validity_options.sorted_by_duration.each_with_index do |option, index| %>
                <div class="validity-option border border-gray-200 rounded-lg p-4 bg-gray-50">
                  <%= form.fields_for :validity_options, option do |option_form| %>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duration Type</label>
                        <%= option_form.select :duration_type, 
                            options_for_select([['Days', 'days'], ['Months', 'months'], ['Years', 'years'], ['Lifetime', 'lifetime']], option.duration_type), 
                            {}, 
                            class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duration Value</label>
                        <%= option_form.number_field :duration_value, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                        <%= option_form.number_field :price, step: 0.01, min: 0, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                        <%= option_form.text_field :label, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
                      </div>
                    </div>
                    <div class="mt-3 flex items-center justify-between">
                      <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                          <%= option_form.check_box :is_default, class: "mr-2" %>
                          <label class="text-sm text-gray-700">Default option</label>
                        </div>
                        <div class="flex items-center">
                          <%= option_form.check_box :active, class: "mr-2" %>
                          <label class="text-sm text-gray-700">Active (show on frontend)</label>
                        </div>
                      </div>
                      <button type="button" onclick="removeValidityOption(this)" class="text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash mr-1"></i>Remove
                      </button>
                    </div>
                    <%= option_form.hidden_field :_destroy %>
                  <% end %>
                </div>
              <% end %>
            </div>
            
            <template id="validity-option-template">
              <div class="validity-option border border-gray-200 rounded-lg p-4 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Duration Type</label>
                    <select name="product[validity_options_attributes][INDEX][duration_type]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="days">Days</option>
                      <option value="months">Months</option>
                      <option value="years">Years</option>
                      <option value="lifetime">Lifetime</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Duration Value</label>
                    <input type="number" name="product[validity_options_attributes][INDEX][duration_value]" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="30">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                    <input type="number" name="product[validity_options_attributes][INDEX][price]" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="999.00">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                    <input type="text" name="product[validity_options_attributes][INDEX][label]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="30 Days">
                  </div>
                </div>
                <div class="mt-3 flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                      <input type="checkbox" name="product[validity_options_attributes][INDEX][is_default]" class="mr-2">
                      <label class="text-sm text-gray-700">Default option</label>
                    </div>
                    <div class="flex items-center">
                      <input type="checkbox" name="product[validity_options_attributes][INDEX][active]" class="mr-2" checked>
                      <label class="text-sm text-gray-700">Active (show on frontend)</label>
                    </div>
                  </div>
                  <button type="button" onclick="removeValidityOption(this)" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-trash mr-1"></i>Remove
                  </button>
                </div>
                <input type="hidden" name="product[validity_options_attributes][INDEX][_destroy]" value="0">
              </div>
            </template>
          </div>
        </div>
        
        <script>
          let validityOptionIndex = <%= @product.validity_options.count %>;
          
          function addValidityOption() {
            const container = document.getElementById('validity-options-container');
            const template = document.getElementById('validity-option-template');
            const clone = template.content.cloneNode(true);
            
            // Replace INDEX with actual index
            clone.querySelectorAll('[name*="INDEX"]').forEach(input => {
              input.name = input.name.replace(/INDEX/g, validityOptionIndex);
            });
            
            // Add event listener to the new default checkbox
            const newDefaultCheckbox = clone.querySelector('input[name*="is_default"]');
            if (newDefaultCheckbox) {
              newDefaultCheckbox.addEventListener('change', handleDefaultCheckboxChange);
            }
            
            container.appendChild(clone);
            validityOptionIndex++;
          }
          
          function removeValidityOption(button) {
            const optionDiv = button.closest('.validity-option');
            const destroyInput = optionDiv.querySelector('[name*="_destroy"]');
            destroyInput.value = '1';
            optionDiv.style.display = 'none';
          }
          
          function handleDefaultCheckboxChange(event) {
            const currentCheckbox = event.target;
            
            if (currentCheckbox.checked) {
              // Uncheck all other default checkboxes
              const allDefaultCheckboxes = document.querySelectorAll('input[name*="is_default"]');
              allDefaultCheckboxes.forEach(checkbox => {
                if (checkbox !== currentCheckbox) {
                  checkbox.checked = false;
                }
              });
            }
          }
          
          // Add event listeners to existing default checkboxes
          document.addEventListener('DOMContentLoaded', function() {
            const defaultCheckboxes = document.querySelectorAll('input[name*="is_default"]');
            defaultCheckboxes.forEach(checkbox => {
              checkbox.addEventListener('change', handleDefaultCheckboxChange);
            });
          });
          
          // Custom features management
          function addCustomFeature() {
            const container = document.getElementById('custom-features-container');
            const newFeatureDiv = document.createElement('div');
            newFeatureDiv.className = 'flex items-center space-x-2 custom-feature-item';
            newFeatureDiv.innerHTML = `
              <input type="text" name="product[features][]" 
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                     placeholder="Enter custom feature"
                     required>
              <button type="button" onclick="removeCustomFeature(this)" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
              </button>
            `;
            container.appendChild(newFeatureDiv);
            
            // Focus on the new input
            const newInput = newFeatureDiv.querySelector('input');
            newInput.focus();
            
            // Show a brief success message
            const successMsg = document.createElement('div');
            successMsg.className = 'text-green-600 text-sm mt-1';
            successMsg.textContent = 'Custom feature field added. Enter your feature and save the product.';
            newFeatureDiv.appendChild(successMsg);
            
            // Remove the message after 3 seconds
            setTimeout(() => {
              if (successMsg.parentNode) {
                successMsg.remove();
              }
            }, 3000);
          }
          
          function removeCustomFeature(button) {
            const featureItem = button.closest('.custom-feature-item');
            featureItem.remove();
          }
        </script>
        
        <!-- Form Actions -->
        <div class="border-t pt-6 flex justify-end space-x-3">
          <%= link_to "Cancel", admin_product_path(@product), class: "bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md font-medium" %>
          <%= form.submit "Update Product", class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
