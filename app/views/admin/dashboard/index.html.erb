<% content_for :title, 'Dashboard' %>
<% content_for :subtitle, 'Overview of your business metrics' %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-users text-blue-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @total_users %></h3>
          <p class="text-gray-600">Total Users</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-shopping-cart text-green-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @total_orders %></h3>
          <p class="text-gray-600">Total Orders</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-rupee-sign text-yellow-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900">₹<%= number_with_precision(@total_revenue, precision: 0) %></h3>
          <p class="text-gray-600">Total Revenue</p>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center">
        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-4">
          <i class="fas fa-clock text-red-600 text-xl"></i>
        </div>
        <div>
          <h3 class="text-2xl font-bold text-gray-900"><%= @pending_orders %></h3>
          <p class="text-gray-600">Pending Orders</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Recent Activity -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Enhanced Revenue Chart -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-900">Monthly Revenue</h3>
          <p class="text-sm text-gray-500">Revenue trends over the last 6 months</p>
        </div>
        <div class="flex items-center space-x-2">
          <div class="w-3 h-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full"></div>
          <span class="text-sm text-gray-600">Revenue</span>
        </div>
      </div>
      
      <!-- Chart Stats -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-chart-line text-white text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-blue-600 font-medium">Current Month</p>
              <p class="text-lg font-bold text-blue-900">₹<%= number_with_precision(@current_month_revenue || 0, precision: 0) %></p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
              <i class="fas fa-percentage text-white text-sm"></i>
            </div>
            <div>
              <p class="text-xs text-green-600 font-medium">Growth</p>
              <p class="text-lg font-bold text-green-900"><%= @revenue_growth || 0 %>%</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="relative">
        <canvas id="revenueChart" width="400" height="300"></canvas>
        <div id="chartTooltip" class="absolute bg-gray-900 text-white px-3 py-2 rounded-lg text-sm pointer-events-none opacity-0 transition-opacity duration-200" style="z-index: 1000;"></div>
      </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-user-plus text-white text-xs"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900">New Users</p>
              <p class="text-xs text-gray-500"><%= @recent_users.count %> this week</p>
            </div>
          </div>
          <%= link_to admin_users_path, class: "text-blue-600 hover:text-blue-800 text-sm" do %>
            View All <i class="fas fa-arrow-right ml-1"></i>
          <% end %>
        </div>
        
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-shopping-bag text-white text-xs"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900">New Orders</p>
              <p class="text-xs text-gray-500"><%= @recent_orders.count %> this week</p>
            </div>
          </div>
          <%= link_to admin_orders_path, class: "text-green-600 hover:text-green-800 text-sm" do %>
            View All <i class="fas fa-arrow-right ml-1"></i>
          <% end %>
        </div>
        
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-envelope text-white text-xs"></i>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900">New Contacts</p>
              <p class="text-xs text-gray-500"><%= @new_contacts %> unread</p>
            </div>
          </div>
          <%= link_to admin_contacts_path, class: "text-yellow-600 hover:text-yellow-800 text-sm" do %>
            View All <i class="fas fa-arrow-right ml-1"></i>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Orders and Users -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
    <!-- Recent Orders -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Recent Orders</h3>
      </div>
      <div class="p-6">
        <% if @recent_orders.any? %>
          <div class="space-y-4">
            <% @recent_orders.each do |order| %>
              <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div>
                  <p class="text-sm font-medium text-gray-900">Order #<%= order.id %></p>
                  <p class="text-xs text-gray-500"><%= order.user&.display_name || order.user_email %></p>
                  <p class="text-xs text-gray-500"><%= order.created_at.strftime("%B %d, %Y") %></p>
                </div>
                <div class="text-right">
                  <p class="text-sm font-semibold text-gray-900">₹<%= order.total_amount %></p>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full
                    <%= case order.status
                        when 'pending' then 'bg-yellow-100 text-yellow-800'
                        when 'paid' then 'bg-blue-100 text-blue-800'
                        when 'shipped' then 'bg-purple-100 text-purple-800'
                        when 'delivered' then 'bg-green-100 text-green-800'
                        when 'cancelled' then 'bg-red-100 text-red-800'
                        else 'bg-gray-100 text-gray-800'
                        end %>">
                    <%= order.status.capitalize %>
                  </span>
                </div>
              </div>
            <% end %>
          </div>
          <%= link_to admin_orders_path, class: "block mt-4 text-center text-blue-600 hover:text-blue-800 text-sm font-medium" do %>
            View All Orders <i class="fas fa-arrow-right ml-1"></i>
          <% end %>
        <% else %>
          <p class="text-gray-500 text-center py-4">No recent orders</p>
        <% end %>
      </div>
    </div>

    <!-- Recent Users -->
    <div class="bg-white rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Recent Users</h3>
      </div>
      <div class="p-6">
        <% if @recent_users.any? %>
          <div class="space-y-4">
            <% @recent_users.each do |user| %>
              <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-user text-white text-xs"></i>
                  </div>
                  <div>
                    <p class="text-sm font-medium text-gray-900"><%= user.display_name %></p>
                    <p class="text-xs text-gray-500"><%= user.email %></p>
                    <p class="text-xs text-gray-500">Joined <%= user.created_at.strftime("%B %d, %Y") %></p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-xs text-gray-500"><%= user.total_orders %> orders</p>
                  <p class="text-xs text-gray-500">₹<%= user.total_spent %></p>
                </div>
              </div>
            <% end %>
          </div>
          <%= link_to admin_users_path, class: "block mt-4 text-center text-blue-600 hover:text-blue-800 text-sm font-medium" do %>
            View All Users <i class="fas fa-arrow-right ml-1"></i>
          <% end %>
        <% else %>
          <p class="text-gray-500 text-center py-4">No recent users</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('revenueChart').getContext('2d');
  const tooltip = document.getElementById('chartTooltip');
  
  const monthlyData = <%= raw @monthly_revenue.to_json %>;
  const labels = Object.keys(monthlyData).map(date => {
    const d = new Date(date);
    return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  });
  const values = Object.values(monthlyData);
  
  // Create gradient background
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
  gradient.addColorStop(1, 'rgba(59, 130, 246, 0.05)');
  
  // Create gradient border
  const borderGradient = ctx.createLinearGradient(0, 0, 400, 0);
  borderGradient.addColorStop(0, '#3B82F6');
  borderGradient.addColorStop(0.5, '#8B5CF6');
  borderGradient.addColorStop(1, '#3B82F6');
  
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Revenue (₹)',
        data: values,
        borderColor: borderGradient,
        backgroundColor: gradient,
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#3B82F6',
        pointBorderColor: '#FFFFFF',
        pointBorderWidth: 3,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointHoverBackgroundColor: '#8B5CF6',
        pointHoverBorderColor: '#FFFFFF',
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      scales: {
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            color: '#6B7280',
            font: {
              size: 12,
              weight: '500'
            },
            padding: 10
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(107, 114, 128, 0.1)',
            drawBorder: false
          },
          ticks: {
            color: '#6B7280',
            font: {
              size: 12,
              weight: '500'
            },
            padding: 10,
            callback: function(value) {
              if (value >= 1000) {
                return '₹' + (value / 1000).toFixed(1) + 'K';
              }
              return '₹' + value.toLocaleString();
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: false,
          external: function(context) {
            const tooltipModel = context.tooltip;
            if (tooltipModel.opacity === 0) {
              tooltip.style.opacity = '0';
              return;
            }
            
            const position = context.chart.canvas.getBoundingClientRect();
            const bodyFont = Chart.helpers.fontString(12, '500', 'Inter');
            
            tooltip.style.opacity = '1';
            tooltip.style.left = position.left + tooltipModel.caretX + 'px';
            tooltip.style.top = position.top + tooltipModel.caretY + 'px';
            
            if (tooltipModel.body) {
              const titleLines = tooltipModel.title || [];
              const bodyLines = tooltipModel.body.map(b => b.lines);
              
              let innerHtml = '<div class="font-semibold mb-1">' + titleLines.join('') + '</div>';
              innerHtml += '<div class="text-blue-200">' + bodyLines.join('') + '</div>';
              
              tooltip.innerHTML = innerHtml;
            }
          }
        }
      },
      animation: {
        duration: 2000,
        easing: 'easeInOutQuart',
        onProgress: function(animation) {
          const chart = animation.chart;
          const ctx = chart.ctx;
          const dataset = chart.data.datasets[0];
          const meta = chart.getDatasetMeta(0);
          
          if (meta.data.length > 0) {
            const firstPoint = meta.data[0];
            const lastPoint = meta.data[meta.data.length - 1];
            
            // Animate gradient
            const progress = animation.currentStep / animation.numSteps;
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, `rgba(59, 130, 246, ${0.3 * progress})`);
            gradient.addColorStop(1, `rgba(59, 130, 246, ${0.05 * progress})`);
            
            dataset.backgroundColor = gradient;
          }
        }
      }
    }
  });
  
  // Add hover effects
  ctx.canvas.addEventListener('mousemove', function(e) {
    const rect = ctx.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const points = chart.getDatasetMeta(0).data;
    points.forEach((point, index) => {
      const distance = Math.sqrt(Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2));
      if (distance < 20) {
        ctx.canvas.style.cursor = 'pointer';
        return;
      }
    });
    ctx.canvas.style.cursor = 'default';
  });
  
  // Add click effects
  ctx.canvas.addEventListener('click', function(e) {
    const rect = ctx.canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const points = chart.getDatasetMeta(0).data;
    points.forEach((point, index) => {
      const distance = Math.sqrt(Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2));
      if (distance < 20) {
        // Add pulse animation to the clicked point
        point._model.radius = 12;
        setTimeout(() => {
          point._model.radius = 6;
          chart.update('none');
        }, 300);
      }
    });
  });
});
</script>
